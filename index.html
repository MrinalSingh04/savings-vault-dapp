<!DOCTYPE html>
<html lang="en"> 
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SavingsVault ¬∑ sepolia dApp</title>
    <!-- ethers v6 (umd) -->
    <script src="https://cdn.jsdelivr.net/npm/ethers@6.10.0/dist/ethers.umd.min.js"></script>
    <!-- Font & basic icons via font-awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        * {
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
        }
        body {
            background: linear-gradient(145deg, #f0f5fa 0%, #e9eff5 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            padding: 2rem 1rem;
            color: #1a2639;
        }
        .card {
            max-width: 1100px;
            width: 100%;
            background: rgba(255,255,255,0.7);
            backdrop-filter: blur(14px);
            -webkit-backdrop-filter: blur(14px);
            border-radius: 42px;
            box-shadow: 0 25px 50px -12px rgba(0,20,40,0.4), inset 0 1px 2px rgba(255,255,255,0.7);
            padding: 2rem 2rem 2.5rem;
            border: 1px solid rgba(255,255,255,0.5);
        }
        h2 {
            font-weight: 600;
            font-size: 2.1rem;
            letter-spacing: -0.02em;
            background: linear-gradient(135deg, #1f2b3d, #2c3e5e);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.25rem;
        }
        h2 i {
            background: #2c3e5e;
            background: linear-gradient(145deg, #2b3b55, #1f2c40);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-size: 2rem;
        }
        .sub-header {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            align-items: center;
            margin-bottom: 2rem;
        }
        .wallet-bar {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }
        .chip {
            background: rgba(10, 30, 50, 0.08);
            backdrop-filter: blur(4px);
            padding: 0.6rem 1.4rem;
            border-radius: 60px;
            font-size: 0.9rem;
            font-weight: 500;
            border: 1px solid rgba(255,255,255,0.6);
            box-shadow: 0 4px 10px rgba(0,0,0,0.02);
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: #1e2f40;
        }
        .chip i {
            color: #3f5e7c;
            width: 18px;
        }
        button.primary, button.secondary, button.admin {
            border: none;
            background: white;
            padding: 0.6rem 1.5rem;
            border-radius: 40px;
            font-weight: 600;
            font-size: 0.95rem;
            box-shadow: 0 8px 16px -6px rgba(0,32,64,0.2), 0 0 0 1px rgba(255,255,255,0.7) inset;
            cursor: pointer;
            transition: all 0.15s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            border: 1px solid rgba(0,0,0,0.02);
        }
        button.primary {
            background: #1a2c42;
            color: white;
            box-shadow: 0 12px 24px -10px #1a2c4260, 0 0 0 1px #ffffff30 inset;
        }
        button.primary i { color: #b7d0eb; }
        button.primary:hover { background: #223a55; transform: scale(1.02); }
        button.secondary:hover { background: #eef3f8; transform: translateY(-2px); }
        button.admin { background: #f1e9db; color: #4d3e2e; }
        hr {
            margin: 2rem 0 1.5rem;
            border: none;
            height: 2px;
            background: linear-gradient(to right, transparent, rgba(0,30,50,0.1), transparent);
        }
        .grid-2 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.8rem;
            margin: 1.5rem 0;
        }
        .panel {
            background: rgba(255,255,255,0.6);
            backdrop-filter: blur(8px);
            border-radius: 32px;
            padding: 1.6rem 1.8rem;
            border: 1px solid rgba(255,255,255,0.8);
            box-shadow: 0 15px 30px -15px rgba(0,20,40,0.2);
        }
        .panel h3 {
            font-weight: 600;
            font-size: 1.4rem;
            margin-bottom: 1.2rem;
            display: flex;
            align-items: center;
            gap: 10px;
            color: #1c2d44;
        }
        .input-group {
            margin-bottom: 1.2rem;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .input-group label {
            font-weight: 600;
            font-size: 0.9rem;
            letter-spacing: 0.02em;
            color: #2e425b;
            margin-left: 6px;
        }
        .input-group input {
            background: rgba(255,255,255,0.8);
            border: 1.5px solid rgba(0,0,0,0.05);
            border-radius: 26px;
            padding: 0.9rem 1.4rem;
            font-size: 1rem;
            outline: none;
            transition: 0.15s;
            box-shadow: inset 0 3px 8px rgba(0,0,0,0.02);
        }
        .input-group input:focus {
            border-color: #4d7399;
            background: white;
            box-shadow: 0 0 0 3px rgba(45, 100, 150, 0.2);
        }
        pre {
            background: rgba(0,0,0,0.02);
            padding: 1.2rem;
            border-radius: 24px;
            font-family: 'SF Mono', 'Fira Code', monospace;
            font-size: 0.9rem;
            border: 1px solid rgba(0,0,0,0.05);
            overflow-x: auto;
            white-space: pre-wrap;
            word-break: break-word;
            box-shadow: inset 0 1px 4px rgba(0,0,0,0.02);
        }
        .action-row {
            display: flex;
            flex-wrap: wrap;
            gap: 0.8rem;
            align-items: center;
            margin: 1rem 0 0.5rem;
        }
        #events {
            background: #0f1a24;
            color: #bcd9f0;
            border-radius: 24px;
            padding: 1.4rem;
            font-size: 0.85rem;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #30495f;
            box-shadow: inset 0 0 0 1px #4d6b83;
        }
        .notification {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: #1e2f40f0;
            backdrop-filter: blur(12px);
            color: white;
            padding: 1rem 2rem 1rem 1.5rem;
            border-radius: 60px;
            font-weight: 500;
            box-shadow: 0 20px 35px -8px #00000050, 0 0 0 1px #ffffff30 inset;
            display: flex;
            align-items: center;
            gap: 16px;
            transform: translateX(400px);
            transition: transform 0.3s cubic-bezier(0.2, 0.9, 0.3, 1.1);
            z-index: 1000;
            border: 1px solid #9bb5d1;
            max-width: 400px;
        }
        .notification.show {
            transform: translateX(0);
        }
        .notification i {
            font-size: 1.5rem;
            color: #b5d3ff;
        }
        .close-notif {
            background: none;
            border: none;
            color: #b0c9e5;
            font-size: 1.2rem;
            cursor: pointer;
            margin-left: 10px;
            padding: 0 6px;
        }
        .admin-area {
            background: #f9f3ea90;
            border-radius: 32px;
            padding: 1.8rem;
            margin-top: 1.5rem;
            border: 1px solid #ffeacd;
        }
        .flex {
            display: flex;
            gap: 0.8rem;
            flex-wrap: wrap;
            align-items: flex-end;
        }
        .text-small {
            font-size: 0.8rem;
            opacity: 0.7;
        }
        .vault-placeholder {
            color: #7f8c9e;
            font-style: italic;
            text-align: center;
            padding: 1rem;
        }
        .account-badge {
            background: #1a2c42;
            color: white;
            padding: 0.3rem 1rem;
            border-radius: 30px;
            font-size: 0.8rem;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
    </style>
</head>
<body>
    <div class="card">
        <h2><i class="fas fa-vault"></i> SavingsVault ¬∑ full dApp</h2>
        <div class="sub-header">
            <div class="wallet-bar">
                <span class="chip"><i class="fas fa-id-card"></i> <span id="wallet">Not connected</span></span>
                <span class="chip"><i class="fas fa-network-wired"></i> <span id="network">‚Äî‚Äî</span></span>
                <span class="account-badge" id="activeAccount" style="display: none;"><i class="fas fa-circle" style="color:#22c55e;"></i> <span id="activeAccountAddress"></span></span>
            </div>
            <button class="primary" onclick="connectWallet()" id="connectButton"><i class="fas fa-plug"></i> Connect wallet</button>
        </div>

        <!-- quick status row -->
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
            <h3 style="font-weight: 500;"><i class="fas fa-chart-line"></i> Contract status</h3>
            <button class="secondary" onclick="loadStatus()"><i class="fas fa-sync-alt"></i> refresh</button>
        </div>
        <pre id="status">‚Äî click Load or connect wallet ‚Äî</pre>

        <!-- main panels grid -->
        <div class="grid-2">
            <!-- left: create vault -->
            <div class="panel">
                <h3><i class="fas fa-plus-circle"></i> Create vault</h3>
                <div class="input-group">
                    <label>‚è±Ô∏è Interval days</label>
                    <input id="interval" type="number" placeholder="e.g. 7" value="1">
                </div>
                <div class="input-group">
                    <label>üì§ Release amount (ETH)</label>
                    <input id="release" placeholder="0.01" value="0.001">
                </div>
                <div class="input-group">
                    <label>üí∞ Deposit amount (ETH)</label>
                    <input id="deposit" placeholder="0.1" value="0.02">
                </div>
                <button class="primary" onclick="createVault()" style="width: 100%; justify-content: center;" id="depositBtn" disabled><i class="fas fa-arrow-down"></i> Deposit & create</button>
                <p class="text-small" style="margin-top: 0.5rem;" id="depositHint"><i class="fas fa-info-circle"></i> Connect wallet to deposit</p>
            </div>

            <!-- right: your vault -->
            <div class="panel">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h3><i class="fas fa-piggy-bank"></i> Your vault</h3>
                    <button class="secondary" onclick="loadVault()" id="loadVaultBtn" disabled><i class="fas fa-download"></i> load</button>
                </div>
                <pre id="vault">‚Äî connect wallet to view ‚Äî</pre>
                <div class="action-row">
                    <button class="secondary" onclick="checkAvailable()" id="checkBtn" disabled><i class="fas fa-hourglass-half"></i> available</button>
                    <button class="primary" onclick="withdraw()" id="withdrawBtn" disabled><i class="fas fa-hand-holding-usd"></i> withdraw</button>
                </div>
                <div id="availableContainer" style="margin-top: 0.8rem; font-weight: 500; background: #d9e6f2; padding: 0.5rem 1.2rem; border-radius: 30px;">
                    <span id="available">‚¨áÔ∏è 0 ETH</span>
                </div>
            </div>
        </div>

        <!-- admin panel (hidden by default, shown if owner) -->
        <div id="adminPanel" class="admin-area" style="display: none;">
            <h3 style="margin-top: 0;"><i class="fas fa-user-shield"></i> Admin panel</h3>
            <div class="flex" style="align-items: flex-end;">
                <div class="input-group" style="flex:2;">
                    <label>üí∞ max deposit (ETH)</label>
                    <input id="maxDeposit" placeholder="10" value="5">
                </div>
                <button class="admin" onclick="setMaxDeposit()" id="setMaxBtn" disabled><i class="fas fa-pen"></i> set</button>
            </div>
            <div style="display: flex; flex-wrap: wrap; gap: 0.6rem; margin: 1.5rem 0 0.5rem;">
                <button class="admin" onclick="pause()" id="pauseBtn" disabled><i class="fas fa-pause-circle"></i> pause</button>
                <button class="admin" onclick="unpause()" id="unpauseBtn" disabled><i class="fas fa-play-circle"></i> unpause</button>
                <div style="flex:2; display: flex; gap: 0.4rem;">
                    <input id="newOwner" placeholder="0x... new owner" style="flex:3; border-radius: 40px; border: 1px solid #bbaa99; padding: 0 1rem;">
                    <button class="admin" onclick="transferOwnership()" id="transferBtn" disabled><i class="fas fa-exchange-alt"></i> transfer</button>
                </div>
                <button class="admin" onclick="renounceOwnership()" style="background: #e6cfc2;" id="renounceBtn" disabled><i class="fas fa-trash-alt"></i> renounce</button>
            </div>
        </div>

        <!-- event log -->
        <div style="margin-top: 2rem;">
            <h3><i class="fas fa-list-ul"></i> Event logs</h3>
            <pre id="events">‚Äî‚Äî live events ‚Äî‚Äî</pre>
        </div>
    </div>

    <!-- fancy notification toaster -->
    <div id="notificationToast" class="notification">
        <i class="fas fa-bell"></i>
        <span id="notifMessage">connected</span>
        <button class="close-notif" onclick="hideNotif()"><i class="fas fa-times"></i></button>
    </div>

    <script>
        // ------ constant & setup ------
        const ADDRESS = "0xb51cCeF7C4FCc1A0063E4f27907b90f07508119E";
        const ABI = [{"inputs":[],"stateMutability":"nonpayable","type":"constructor"},{"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"availableToWithdraw","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"intervalInDays","type":"uint256"},{"internalType":"uint256","name":"releaseAmount","type":"uint256"}],"name":"deposit","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"getVaultDetails","outputs":[{"internalType":"uint256","name":"totalDeposited","type":"uint256"},{"internalType":"uint256","name":"withdrawn","type":"uint256"},{"internalType":"uint256","name":"startTime","type":"uint256"},{"internalType":"uint256","name":"interval","type":"uint256"},{"internalType":"uint256","name":"releaseAmount","type":"uint256"},{"internalType":"uint256","name":"available","type":"uint256"},{"internalType":"uint256","name":"remaining","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"withdraw","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"maxDeposit","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"paused","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"vaults","outputs":[{"internalType":"uint256","name":"totalDeposited","type":"uint256"},{"internalType":"uint256","name":"withdrawn","type":"uint256"},{"internalType":"uint256","name":"startTime","type":"uint256"},{"internalType":"uint256","name":"interval","type":"uint256"},{"internalType":"uint256","name":"releaseAmount","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_amount","type":"uint256"}],"name":"setMaxDeposit","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"pause","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"unpause","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"renounceOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"newOwner","type":"address"}],"name":"transferOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"interval","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"releaseAmount","type":"uint256"}],"name":"Deposited","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"remaining","type":"uint256"}],"name":"Withdrawn","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"oldAmount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"newAmount","type":"uint256"}],"name":"MaxDepositUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"previousOwner","type":"address"},{"indexed":true,"internalType":"address","name":"newOwner","type":"address"}],"name":"OwnershipTransferred","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"address","name":"account","type":"address"}],"name":"Paused","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"address","name":"account","type":"address"}],"name":"Unpaused","type":"event"}];

        let provider, signer, contract, user;
        let toastTimer;
        let accountChangeInProgress = false;

        // DOM elements
        const connectBtn = document.getElementById('connectButton');
        const depositBtn = document.getElementById('depositBtn');
        const loadVaultBtn = document.getElementById('loadVaultBtn');
        const checkBtn = document.getElementById('checkBtn');
        const withdrawBtn = document.getElementById('withdrawBtn');
        const setMaxBtn = document.getElementById('setMaxBtn');
        const pauseBtn = document.getElementById('pauseBtn');
        const unpauseBtn = document.getElementById('unpauseBtn');
        const transferBtn = document.getElementById('transferBtn');
        const renounceBtn = document.getElementById('renounceBtn');
        const activeAccountEl = document.getElementById('activeAccount');
        const activeAccountAddressEl = document.getElementById('activeAccountAddress');
        const depositHint = document.getElementById('depositHint');

        // notification helper
        function showNotif(msg, isError = false) {
            const toast = document.getElementById('notificationToast');
            document.getElementById('notifMessage').innerText = msg;
            toast.style.background = isError ? '#601010f0' : '#1e2f40f0';
            toast.classList.add('show');
            if (toastTimer) clearTimeout(toastTimer);
            toastTimer = setTimeout(() => {
                toast.classList.remove('show');
            }, 5000);
        }
        window.hideNotif = function() {
            document.getElementById('notificationToast').classList.remove('show');
        }

        function logEvent(msg) {
            const el = document.getElementById("events");
            el.textContent += msg + "\n";
            el.scrollTop = el.scrollHeight;
        }

        function decodeError(e) {
            if (e.reason) return e.reason;
            if (e.data?.message) return e.data.message;
            if (e.shortMessage) return e.shortMessage;
            return e.message || "unknown error";
        }

        // Update UI based on connection state
        function updateUIForConnection() {
            const isConnected = !!user && !!contract;
            
            // Update connect button
            if (isConnected) {
                connectBtn.innerHTML = '<i class="fas fa-check-circle"></i> Connected';
                connectBtn.style.background = '#2b6e3b';
                activeAccountEl.style.display = 'inline-flex';
                activeAccountAddressEl.innerText = `${user.slice(0,6)}...${user.slice(-4)}`;
                depositHint.innerHTML = '<i class="fas fa-check-circle" style="color:#2b6e3b;"></i> Ready to deposit';
                
                // Enable all buttons
                [depositBtn, loadVaultBtn, checkBtn, withdrawBtn].forEach(btn => btn.disabled = false);
                
                // Load vault data for current user
                loadVault();
                checkAvailable();
            } else {
                connectBtn.innerHTML = '<i class="fas fa-plug"></i> Connect wallet';
                connectBtn.style.background = '#1a2c42';
                activeAccountEl.style.display = 'none';
                depositHint.innerHTML = '<i class="fas fa-info-circle"></i> Connect wallet to deposit';
                
                // Disable all buttons
                [depositBtn, loadVaultBtn, checkBtn, withdrawBtn, setMaxBtn, pauseBtn, unpauseBtn, transferBtn, renounceBtn].forEach(btn => btn.disabled = true);
                
                // Clear user-specific data
                document.getElementById("vault").innerHTML = '‚Äî connect wallet to view ‚Äî';
                document.getElementById("available").innerHTML = '‚¨áÔ∏è 0 ETH';
                document.getElementById("status").innerHTML = '‚Äî click Load or connect wallet ‚Äî';
                document.getElementById("wallet").innerHTML = 'Not connected';
            }
        }

        // Handle account changes
        function setupAccountListener() {
            if (window.ethereum) {
                window.ethereum.on('accountsChanged', async (accounts) => {
                    if (accountChangeInProgress) return;
                    accountChangeInProgress = true;
                    
                    if (accounts.length === 0) {
                        // User disconnected
                        user = null;
                        contract = null;
                        signer = null;
                        updateUIForConnection();
                        showNotif('üëã Wallet disconnected');
                    } else {
                        // Account switched
                        showNotif('üîÑ Account changed, reloading...');
                        // Re-initialize with new account
                        await connectWallet(true); // silent mode
                    }
                    
                    accountChangeInProgress = false;
                });

                window.ethereum.on('chainChanged', (chainId) => {
                    // Handle chain change
                    if (chainId !== '0xaa36a7') { // 11155111 in hex
                        showNotif('‚ö†Ô∏è Please switch to Sepolia network', true);
                    }
                    window.location.reload(); // Simplest way to reset state
                });
            }
        }

        // Modified connectWallet with silent option
        async function connectWallet(silent = false) {
            if (!window.ethereum) {
                if (!silent) {
                    showNotif("ü¶ä MetaMask not installed", true);
                    alert("Install MetaMask");
                }
                return;
            }
            
            try {
                if (!silent) showNotif("üîÑ Connecting wallet...");
                
                provider = new ethers.BrowserProvider(window.ethereum);
                
                const net = await provider.getNetwork();
                if (net.chainId !== 11155111n) {
                    if (!silent) {
                        showNotif("‚ö†Ô∏è Switch to Sepolia network", true);
                        alert("Switch to Sepolia");
                    }
                    return;
                }
                
                await provider.send("eth_requestAccounts", []);
                signer = await provider.getSigner();
                user = await signer.getAddress();
                
                contract = new ethers.Contract(ADDRESS, ABI, signer);
                
                document.getElementById("wallet").innerHTML = `<i class="fas fa-circle" style="color:#22c55e; font-size:0.6rem;"></i> ${user.slice(0,6)}...${user.slice(-4)}`;
                document.getElementById("network").innerText = "Sepolia üü¢";
                
                if (!silent) showNotif(`‚úÖ Connected: ${user.slice(0,6)}...${user.slice(-4)}`);
                
                // Update UI
                updateUIForConnection();
                
                // Setup events if not already
                setupEvents();
                
                // Check if owner
                await checkOwner();
                
                // Load contract status
                await loadStatus();
                
            } catch (e) {
                if (!silent) {
                    showNotif("Connection failed", true);
                    console.error(e);
                }
                // Reset UI on failure
                user = null;
                contract = null;
                updateUIForConnection();
            }
        }

        async function checkOwner() {
            if (!contract || !user) {
                // Hide admin panel if not connected
                document.getElementById("adminPanel").style.display = "none";
                return;
            }
            
            try {
                const owner = await contract.owner();
                const isOwner = owner.toLowerCase() === user.toLowerCase();
                
                if (isOwner) {
                    document.getElementById("adminPanel").style.display = "block";
                    // Enable admin buttons
                    [setMaxBtn, pauseBtn, unpauseBtn, transferBtn, renounceBtn].forEach(btn => btn.disabled = false);
                } else {
                    document.getElementById("adminPanel").style.display = "none";
                }
            } catch (e) {
                console.log("Error checking owner:", e);
                document.getElementById("adminPanel").style.display = "none";
            }
        }

        async function loadStatus() {
            if (!contract) { 
                document.getElementById("status").innerHTML = '‚Äî connect wallet first ‚Äî';
                return; 
            }
            
            try {
                const max = await contract.maxDeposit();
                const paused = await contract.paused();
                const owner = await contract.owner();
                document.getElementById("status").innerHTML = `
üë§ Owner: <span style="color:#1e3b5a;">${owner}</span><br>
‚è∏Ô∏è Paused: <span style="color:${paused ? '#b44' : '#2b6e3b'};">${paused}</span><br>
üì¶ Max deposit: <strong>${ethers.formatEther(max)} ETH</strong>
                `;
            } catch (e) {
                showNotif(decodeError(e), true);
            }
        }

        async function createVault() {
            if (!contract) { showNotif("Connect first", true); return; }
            
            try {
                const i = document.getElementById("interval").value;
                const r = document.getElementById("release").value;
                const d = document.getElementById("deposit").value;
                
                if (!i || !r || !d) throw new Error("fill all fields");

                const releaseWei = ethers.parseEther(r);
                const depositWei = ethers.parseEther(d);

                const tx = await contract.deposit(i, releaseWei, { value: depositWei });
                showNotif(`‚è≥ depositing...`);
                await tx.wait();
                showNotif(`‚úÖ Vault created ¬∑ ${d} ETH`);
                loadVault();
                loadStatus();
            } catch (e) {
                showNotif(`‚ùå ${decodeError(e)}`, true);
            }
        }

        async function loadVault() {
            if (!contract || !user) { 
                document.getElementById("vault").innerHTML = '‚Äî connect wallet to view ‚Äî';
                return; 
            }
            
            try {
                const v = await contract.getVaultDetails(user);
                const fmt = (x) => ethers.formatEther(x);
                document.getElementById("vault").innerHTML = `
üí∞ total: <strong>${fmt(v[0])} ETH</strong><br>
üì§ withdrawn: ${fmt(v[1])} ETH<br>
üïí start: ${new Date(Number(v[2])*1000).toLocaleString()}<br>
‚è≤Ô∏è interval: ${v[3]} sec<br>
üîì release/interval: ${fmt(v[4])} ETH<br>
‚ú® available: ${fmt(v[5])} ETH<br>
üìå remaining: ${fmt(v[6])} ETH
                `;
            } catch (e) {
                if (e.message.includes("no vault")) {
                    document.getElementById("vault").innerHTML = '‚Äî no vault found for this account ‚Äî';
                } else {
                    showNotif(decodeError(e), true);
                }
            }
        }

        async function checkAvailable() {
            if (!contract || !user) return;
            
            try {
                const a = await contract.availableToWithdraw(user);
                document.getElementById("available").innerHTML = `‚¨áÔ∏è <strong>${ethers.formatEther(a)} ETH</strong> available`;
            } catch (e) {
                document.getElementById("available").innerHTML = '‚¨áÔ∏è 0 ETH';
                if (!e.message.includes("no vault")) {
                    showNotif(decodeError(e), true);
                }
            }
        }

        async function withdraw() {
            if (!contract) return;
            
            try {
                const tx = await contract.withdraw();
                showNotif(`‚è≥ withdraw request sent`);
                await tx.wait();
                showNotif(`üí∏ withdrawal successful`);
                loadVault(); 
                checkAvailable();
            } catch (e) {
                showNotif(`‚ùå ${decodeError(e)}`, true);
            }
        }

        // admin functions
        async function setMaxDeposit() {
            try {
                const val = document.getElementById("maxDeposit").value;
                const tx = await contract.setMaxDeposit(ethers.parseEther(val));
                showNotif("updating max deposit...");
                await tx.wait();
                showNotif("‚úÖ max deposit updated");
                loadStatus();
            } catch (e) { showNotif(decodeError(e), true); }
        }
        
        async function pause() {
            try { 
                await (await contract.pause()).wait(); 
                showNotif("‚è∏Ô∏è contract paused"); 
                loadStatus();
            } catch (e) { showNotif(decodeError(e), true); }
        }
        
        async function unpause() {
            try { 
                await (await contract.unpause()).wait(); 
                showNotif("‚ñ∂Ô∏è contract unpaused");
                loadStatus();
            } catch (e) { showNotif(decodeError(e), true); }
        }
        
        async function transferOwnership() {
            try {
                const addr = document.getElementById("newOwner").value;
                if (!ethers.isAddress(addr)) throw new Error("invalid address");
                await (await contract.transferOwnership(addr)).wait();
                showNotif(`üëë ownership transferred`);
                setTimeout(() => checkOwner(), 1500);
            } catch (e) { showNotif(decodeError(e), true); }
        }
        
        async function renounceOwnership() {
            if (!confirm("‚ö†Ô∏è Really renounce ownership? This cannot be undone!")) return;
            try { 
                await (await contract.renounceOwnership()).wait(); 
                showNotif("üëë ownership renounced"); 
                checkOwner(); 
            } catch (e) { showNotif(decodeError(e), true); }
        }

        // events
        function setupEvents() {
            if (!contract) return;
            
            // Remove old listeners to avoid duplicates
            contract.removeAllListeners();
            
            contract.on("Deposited", (u, a, i, r) => {
                logEvent(`üì• Deposit: ${u.slice(0,6)}.. ${ethers.formatEther(a)} ETH`);
                // If it's the current user, refresh data
                if (user && u.toLowerCase() === user.toLowerCase()) {
                    loadVault();
                    checkAvailable();
                }
            });
            
            contract.on("Withdrawn", (u, a, rem) => {
                logEvent(`üì§ Withdraw: ${u.slice(0,6)}.. ${ethers.formatEther(a)} ETH`);
                if (user && u.toLowerCase() === user.toLowerCase()) {
                    loadVault();
                    checkAvailable();
                }
            });
            
            contract.on("MaxDepositUpdated", (o, n) => {
                logEvent(`‚öôÔ∏è maxDeposit: ${ethers.formatEther(o)} ‚Üí ${ethers.formatEther(n)} ETH`);
                loadStatus();
            });
            
            contract.on("Paused", (addr) => { 
                logEvent(`‚è∏Ô∏è paused by ${addr.slice(0,6)}..`); 
                loadStatus();
            });
            
            contract.on("Unpaused", (addr) => { 
                logEvent(`‚ñ∂Ô∏è unpaused by ${addr.slice(0,6)}..`);
                loadStatus();
            });
            
            contract.on("OwnershipTransferred", (prev, curr) => { 
                logEvent(`üëë ownership: ${prev.slice(0,6)}.. ‚Üí ${curr.slice(0,6)}..`);
                checkOwner();
            });
        }

        // Initialize
        window.onload = () => {
            setupAccountListener();
            updateUIForConnection();
        };

        // Expose functions globally
        window.connectWallet = connectWallet;
        window.loadStatus = loadStatus;
        window.createVault = createVault;
        window.loadVault = loadVault;
        window.checkAvailable = checkAvailable;
        window.withdraw = withdraw;
        window.setMaxDeposit = setMaxDeposit;
        window.pause = pause;
        window.unpause = unpause;
        window.transferOwnership = transferOwnership;
        window.renounceOwnership = renounceOwnership;
    </script>
</body>
</html>